DROP DATABASE IF EXISTS SistemasCRM_V2;
CREATE DATABASE SistemasCRM_V2;
USE SistemasCRM_V2;

-- 1. Tablas base
CREATE TABLE COMUNAS (
    IDCOMUNA VARCHAR(20) PRIMARY KEY,
    DESCRIPCION VARCHAR(100) NOT NULL
);

CREATE TABLE CLIENTES (
    RUT VARCHAR(10) PRIMARY KEY,
    CORREO VARCHAR(255) NOT NULL,
    NOMBRES VARCHAR(100) NOT NULL,
    APELLIDOP VARCHAR(100) NOT NULL,
    APELLIDOM VARCHAR(100) NOT NULL,
    TELEFONO NUMERIC(9) NOT NULL,
    EDAD TINYINT NOT NULL,
    DIRECCION VARCHAR(100) NOT NULL,
    IDCOMUNA VARCHAR(20) NOT NULL,
    FOREIGN KEY (IDCOMUNA) REFERENCES COMUNAS(IDCOMUNA)
);

CREATE TABLE CUENTAS_CLIENTES (
    IDCUENTA VARCHAR(20) PRIMARY KEY,
    RUT VARCHAR(10) NOT NULL,
    CLASE VARCHAR(20) NOT NULL,
    FOREIGN KEY (RUT) REFERENCES CLIENTES(RUT)
);

CREATE TABLE PRODUCTOS (
    IDPRODUCTO VARCHAR(20) PRIMARY KEY,
    TIPO VARCHAR(20) NOT NULL CHECK (TIPO IN ('DESCUENTO','BANDA_ANCHA','TELEVISION','TELEFONIA','PREPAGO','POSTPAGO')),
    DESCRIPCION VARCHAR(100) NOT NULL,
    MODALIDAD VARCHAR(10) NOT NULL CHECK (MODALIDAD IN ('FIJO','MOVIL'))
);

CREATE TABLE ADICIONALES (
    IDADICIONALES VARCHAR(20) PRIMARY KEY,
    COSTOT DECIMAL(10,2) NOT NULL
);

CREATE TABLE DETALLE_ADICIONALES (
    IDADICIONALES VARCHAR(20),
    IDPRODUCTO VARCHAR(20),
    COSTO DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (IDADICIONALES) REFERENCES ADICIONALES(IDADICIONALES),
    FOREIGN KEY (IDPRODUCTO) REFERENCES PRODUCTOS(IDPRODUCTO)
);

CREATE TABLE PLANES (
    IDPLAN VARCHAR(20) PRIMARY KEY,
    NOMBRE VARCHAR(100) NOT NULL,
    COSTOT DECIMAL(10,2) NOT NULL
);

CREATE TABLE DETALLE_PLANES (
    IDPLAN VARCHAR(20),
    IDPRODUCTO VARCHAR(20),
    COSTO DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (IDPLAN) REFERENCES PLANES(IDPLAN),
    FOREIGN KEY (IDPRODUCTO) REFERENCES PRODUCTOS(IDPRODUCTO)
);

CREATE TABLE DESCUENTOS (
    IDDESCUENTOS VARCHAR(20) PRIMARY KEY,
    COSTOT DECIMAL(10,2) NOT NULL
);

CREATE TABLE DETALLE_DESCUENTOS (
    IDDESCUENTOS VARCHAR(20),
    IDPRODUCTO VARCHAR(20),
    COSTO DECIMAL(10,2),
    FOREIGN KEY (IDDESCUENTOS) REFERENCES DESCUENTOS(IDDESCUENTOS),
    FOREIGN KEY (IDPRODUCTO) REFERENCES PRODUCTOS(IDPRODUCTO)
);

CREATE TABLE PRODUCTOS_INSTALADOS (
    IDCUENTA VARCHAR(20),
    IDADICIONALES VARCHAR(20),
    IDPLAN VARCHAR(20),
    IDDESCUENTOS VARCHAR(20),
    FOREIGN KEY (IDCUENTA) REFERENCES CUENTAS_CLIENTES(IDCUENTA),
    FOREIGN KEY (IDADICIONALES) REFERENCES ADICIONALES(IDADICIONALES),
    FOREIGN KEY (IDPLAN) REFERENCES PLANES(IDPLAN),
    FOREIGN KEY (IDDESCUENTOS) REFERENCES DESCUENTOS(IDDESCUENTOS)
);

CREATE TABLE OFFERTAS (
    IDOFERTAS VARCHAR(20) PRIMARY KEY,
    IDCUENTA VARCHAR(20) NOT NULL,
    COSTOT DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (IDCUENTA) REFERENCES CUENTAS_CLIENTES(IDCUENTA)
);

CREATE TABLE DETALLE_OFERTAS (
    IDOFERTAS VARCHAR(20),
    IDPRODUCTO VARCHAR(20),
    COSTO DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (IDOFERTAS) REFERENCES OFFERTAS(IDOFERTAS),
    FOREIGN KEY (IDPRODUCTO) REFERENCES PRODUCTOS(IDPRODUCTO)
);

CREATE TABLE ROLES (
    IDROL VARCHAR(20) PRIMARY KEY,
    DESCRIPCION VARCHAR(100) NOT NULL
);

CREATE TABLE PAISES (
    IDPAIS VARCHAR(20) PRIMARY KEY,
    DESCRIPCION VARCHAR(100) NOT NULL
);

CREATE TABLE USUARIOS (
    IDUSUARIO VARCHAR(20) PRIMARY KEY,
    RUT VARCHAR(20) UNIQUE,
    IDROL VARCHAR(20) NOT NULL,
    IDPAIS VARCHAR(20) NOT NULL,
    CLAVE VARCHAR(255) NOT NULL,
    NOMBRES VARCHAR(100) NOT NULL,
    APELLIDOP VARCHAR(100) NOT NULL,
    APELLIDOM VARCHAR(100) NOT NULL,
    AREA VARCHAR(20) NOT NULL,
    FECHA_CREACION DATE NOT NULL,
    FOREIGN KEY (IDROL) REFERENCES ROLES(IDROL),
    FOREIGN KEY (IDPAIS) REFERENCES PAISES(IDPAIS)
);

CREATE TABLE USUARIO_ROL (
    IDUSUARIO VARCHAR(20),
    IDROL VARCHAR(20),
    FOREIGN KEY (IDUSUARIO) REFERENCES USUARIOS(IDUSUARIO),
    FOREIGN KEY (IDROL) REFERENCES ROLES(IDROL)
);

CREATE TABLE FUNCIONES (
    IDFUNCION VARCHAR(20) PRIMARY KEY,
    DESCRIPCION VARCHAR(100) NOT NULL
);

CREATE TABLE ROL_FUNCION (
    IDROL VARCHAR(20),
    IDFUNCION VARCHAR(20),
    FOREIGN KEY (IDROL) REFERENCES ROLES(IDROL),
    FOREIGN KEY (IDFUNCION) REFERENCES FUNCIONES(IDFUNCION)
);

CREATE TABLE ACTIVIDADES (
    IDACTIVIDAD VARCHAR(20) PRIMARY KEY,
    IDCUENTA VARCHAR(20) NOT NULL,
    DESCRIPCION VARCHAR(100) NOT NULL,
    FECHA_CREACION DATE NOT NULL,
    FECHA_CIERRE DATE NOT NULL,
    TIPO VARCHAR(20) NOT NULL,
    RAZON VARCHAR(20) NOT NULL,
    DETALLE VARCHAR(20) NOT NULL,
    RESOLUCION VARCHAR(20) NOT NULL,
    COMENTARIOS TEXT NOT NULL,
    TELEFONO NUMERIC(9),
    CORREO VARCHAR(255) NOT NULL,
    FOREIGN KEY (IDCUENTA) REFERENCES CUENTAS_CLIENTES(IDCUENTA)
);

CREATE TABLE PEDIDOS (
    IDPEDIDO VARCHAR(20) PRIMARY KEY,
    IDCUENTA VARCHAR(20) NOT NULL,
    ESTADO VARCHAR(20) NOT NULL,
    FECHA_CREACION DATE NOT NULL,
    FECHA_ACTUALIZACION DATE NOT NULL,
    TIPO VARCHAR(20) NOT NULL,
    MODALIDAD VARCHAR(10) NOT NULL CHECK (MODALIDAD IN ('FIJO','MOVIL')),
    USUARIO_CREADOR VARCHAR(20) NOT NULL,
    USUARIO_MODIFICADOR VARCHAR(20) NOT NULL,
    FOREIGN KEY (IDCUENTA) REFERENCES CUENTAS_CLIENTES(IDCUENTA),
    FOREIGN KEY (USUARIO_CREADOR) REFERENCES USUARIOS(IDUSUARIO),
    FOREIGN KEY (USUARIO_MODIFICADOR) REFERENCES USUARIOS(IDUSUARIO)
);

CREATE TABLE DETALLE_PEDIDOS (
    IDPEDIDO VARCHAR(20),
    IDADICIONALES VARCHAR(20),
    IDPLAN VARCHAR(20),
    IDDESCUENTOS VARCHAR(20),
    FOREIGN KEY (IDPEDIDO) REFERENCES PEDIDOS(IDPEDIDO),
    FOREIGN KEY (IDADICIONALES) REFERENCES ADICIONALES(IDADICIONALES),
    FOREIGN KEY (IDPLAN) REFERENCES PLANES(IDPLAN),
    FOREIGN KEY (IDDESCUENTOS) REFERENCES DESCUENTOS(IDDESCUENTOS)
);

CREATE TABLE SOLICITUDES (
    IDSOLICITUD VARCHAR(20) PRIMARY KEY,
    IDCUENTA VARCHAR(20) NOT NULL,
    TIPO VARCHAR(20) NOT NULL,
    ESTADO VARCHAR(20) NOT NULL,
    AREA VARCHAR(20) NOT NULL,
    SUBAREA VARCHAR(20) NOT NULL,
    TIPO_REQUERIMIENTO VARCHAR(100) NOT NULL,
    FECHA_CREACION DATE NOT NULL,
    FECHA_CIERRE DATE NOT NULL,
    COMENTARIOS TEXT NOT NULL,
    FOREIGN KEY (IDCUENTA) REFERENCES CUENTAS_CLIENTES(IDCUENTA)
);

CREATE TABLE MESA_CENTRAL (
    IDACTIVIDAD VARCHAR(20) NOT NULL,
    TELEFONO NUMERIC(9) NOT NULL,
    LUGAR VARCHAR(100) NOT NULL,
    FOREIGN KEY (IDACTIVIDAD) REFERENCES ACTIVIDADES(IDACTIVIDAD)
);

CREATE TABLE ACTIVIDADES_PEDIDOS (
    IDACTIVIDAD VARCHAR(20) NOT NULL,
    IDPEDIDO VARCHAR(20) NOT NULL,
    CATEGORIA VARCHAR(100) NOT NULL,
    FOREIGN KEY (IDACTIVIDAD) REFERENCES ACTIVIDADES(IDACTIVIDAD),
    FOREIGN KEY (IDPEDIDO) REFERENCES PEDIDOS(IDPEDIDO)
);

CREATE TABLE ACTIVIDADES_SOLICITUDES (
    IDACTIVIDAD VARCHAR(20) NOT NULL,
    IDSOLICITUD VARCHAR(20) NOT NULL,
    FOREIGN KEY (IDACTIVIDAD) REFERENCES ACTIVIDADES(IDACTIVIDAD),
    FOREIGN KEY (IDSOLICITUD) REFERENCES SOLICITUDES(IDSOLICITUD)
);

-- COMUNAS
INSERT INTO COMUNAS (IDCOMUNA, DESCRIPCION) VALUES ('C001', 'Santiago'), ('C002', 'Providencia');

-- CLIENTES
INSERT INTO CLIENTES (RUT, CORREO, NOMBRES, APELLIDOP, APELLIDOM, TELEFONO, EDAD, DIRECCION, IDCOMUNA) VALUES
('11111111-1', 'pedro@gmail.com', 'Pedro', 'Perez', 'Gomez', 912345678, 65, 'Calle Falsa 123', 'C001'),
('22222222-2', 'ana@gmail.com', 'Ana', 'Torres', 'Rojas', 987654321, 30, 'Avenida Real 456', 'C002'),
('33333333-3', 'luis@gmail.com', 'Luis', 'Martinez', 'Lopez', 934567890, 45, 'Pasaje Norte 789', 'C001'),
('44444444-4', 'carla@gmail.com', 'Carla', 'Mu√±oz', 'Diaz', 923456789, 38, 'Camino Sur 321', 'C002');

-- CUENTAS_CLIENTES
INSERT INTO CUENTAS_CLIENTES (IDCUENTA, RUT, CLASE) VALUES 
('1-1111-CLI', '11111111-1', 'CLIENTE'),
('1-1111-FAC', '11111111-1', 'FACTURACION'),
('1-1111-SER', '11111111-1', 'SERVICIO'),
('2-2222-CLI', '22222222-2', 'CLIENTE'),
('2-2222-FAC', '22222222-2', 'FACTURACION'),
('2-2222-SER', '22222222-2', 'SERVICIO'),
('3-3333-CLI', '33333333-3', 'CLIENTE'),
('3-3333-FAC', '33333333-3', 'FACTURACION'),
('3-3333-SER', '33333333-3', 'SERVICIO'),
('4-4444-CLI', '44444444-4', 'CLIENTE'),
('4-4444-FAC', '44444444-4', 'FACTURACION'),
('4-4444-SER', '44444444-4','SERVICIO');

-- PRODUCTOS
INSERT INTO PRODUCTOS (IDPRODUCTO, TIPO, DESCRIPCION, MODALIDAD) VALUES
('P001', 'BANDA_ANCHA', 'Fibra Hogar 600 megas', 'FIJO'),
('P002', 'TELEVISION', 'TV Inicia', 'FIJO'),
('P003', 'DESCUENTO', 'Retenciones N1', 'FIJO');

-- ADICIONALES
INSERT INTO ADICIONALES (IDADICIONALES, COSTOT) VALUES ('A001', 5000.00);
INSERT INTO DETALLE_ADICIONALES (IDADICIONALES, IDPRODUCTO, COSTO) VALUES ('A001', 'P001', 5000.00);

-- PLANES
INSERT INTO PLANES (IDPLAN, NOMBRE, COSTOT) VALUES ('PL001', 'Plan Claro Hogar', 25000.00);
INSERT INTO DETALLE_PLANES (IDPLAN, IDPRODUCTO, COSTO) VALUES ('PL001', 'P001', 15000.00), ('PL001', 'P002', 10000.00);

-- DESCUENTOS
INSERT INTO DESCUENTOS (IDDESCUENTOS, COSTOT) VALUES ('D001', 3000.00);
INSERT INTO DETALLE_DESCUENTOS (IDDESCUENTOS, IDPRODUCTO, COSTO) VALUES ('D001', 'P003', 3000.00);

-- PRODUCTOS INSTALADOS
INSERT INTO PRODUCTOS_INSTALADOS (IDCUENTA, IDADICIONALES, IDPLAN, IDDESCUENTOS) VALUES ('1-1111-CLI', 'A001', 'PL001', 'D001');

-- OFERTAS
INSERT INTO OFFERTAS (IDOFERTAS, IDCUENTA, COSTOT) VALUES ('O001', '1-1111-CLI', 27000.00);
INSERT INTO DETALLE_OFERTAS (IDOFERTAS, IDPRODUCTO, COSTO) VALUES ('O001', 'P001', 15000.00), ('O001', 'P002', 10000.00);

-- ROLES Y PAISES
INSERT INTO ROLES (IDROL, DESCRIPCION) VALUES ('R001', 'Administrador');
INSERT INTO ROLES (IDROL, DESCRIPCION) VALUES ('D001', 'Usuario ');
INSERT INTO ROLES (IDROL, DESCRIPCION) VALUES ('S001', 'Supervisor');
INSERT INTO PAISES (IDPAIS, DESCRIPCION) VALUES ('CHL', 'Chile');

-- USUARIOS (para login)
INSERT INTO USUARIOS (IDUSUARIO, RUT, IDROL, IDPAIS, CLAVE, NOMBRES, APELLIDOP, APELLIDOM, AREA, FECHA_CREACION) VALUES
('U001', '22222222-2', 'R001', 'CHL', 'clave123', 'Camila', 'Gonzalez', 'Lopez', 'Ventas', '2025-06-01'),
('U002', '33333333-3', 'D001', 'CHL', 'usuario123', 'Juan', 'Perez', 'Martinez', 'Soporte', '2025-06-01'),
('U003', '44444444-4', 'S001', 'CHL', 'super123', 'Maria', 'Rodriguez', 'Silva', 'Administraci√≥n', '2025-06-01');


-- ACTIVIDADES
INSERT INTO ACTIVIDADES (IDACTIVIDAD, IDCUENTA, DESCRIPCION, FECHA_CREACION, FECHA_CIERRE, TIPO, RAZON, DETALLE, RESOLUCION, COMENTARIOS, TELEFONO, CORREO) VALUES
('1-AX234404', '1-1111-CLI', 'Revisi√≥n de servicio', '2025-06-01', '2025-06-02', 'RECLAMO', 'MALA_CONEXION', 'BAJA_VELOCIDAD', 'RESETEO_ROUTER', 'Usuario report√≥ lentitud.', 912345678, 'pedro@gmail.com'),
('2-BY345505', '2-2222-CLI', 'Instalaci√≥n nueva l√≠nea', '2025-07-10', '2025-07-15', 'INSTALACION', 'NUEVA_LINEA', 'FIBRA_OPTICA', 'PENDIENTE', 'Cliente solicita instalaci√≥n de fibra √≥ptica.', 987654321, 'ana@gmail.com'),
('3-CZ456606', '3-3333-CLI', 'Cambio de plan', '2025-07-10', '2025-07-12', 'MODIFICACION', 'CAMBIO_PLAN', 'UPGRADE_VELOCIDAD', 'PENDIENTE', 'Cliente quiere aumentar velocidad de internet.', 934567890, 'luis@gmail.com'),
('4-DA567707', '4-4444-CLI', 'Soporte t√©cnico', '2025-07-10', '2025-07-11', 'SOPORTE', 'PROBLEMA_TECNICO', 'SIN_SENAL', 'PENDIENTE', 'Cliente reporta falta de se√±al de TV.', 923456789, 'carla@gmail.com');

-- PEDIDOS
INSERT INTO PEDIDOS (IDPEDIDO, IDCUENTA, ESTADO, FECHA_CREACION, FECHA_ACTUALIZACION, TIPO, MODALIDAD, USUARIO_CREADOR, USUARIO_MODIFICADOR) VALUES
('1-1111-CLI', '1-1111-CLI', 'PENDIENTE', '2025-06-01', '2025-06-01', 'INSTALACION', 'FIJO', 'U001', 'U001');
INSERT INTO DETALLE_PEDIDOS (IDPEDIDO, IDADICIONALES, IDPLAN, IDDESCUENTOS) VALUES ('1-1111-CLI', 'A001', 'PL001', 'D001');

-- SOLICITUDES
INSERT INTO SOLICITUDES (IDSOLICITUD, IDCUENTA, TIPO, ESTADO, AREA, SUBAREA, TIPO_REQUERIMIENTO, FECHA_CREACION, FECHA_CIERRE, COMENTARIOS) VALUES
('S001', '1-1111-CLI', 'RECLAMO', 'ABIERTA', 'T√âCNICA', 'INTERNET', 'LENTITUD', '2025-06-01', '2025-06-02', 'Cliente requiere revisi√≥n de internet.');
INSERT INTO ACTIVIDADES_SOLICITUDES (IDACTIVIDAD, IDSOLICITUD) VALUES ('1-AX234404','S001');